nextflow_workflow {

    name "Test Subworkflow UTILS_OPTIONS"
    script "../main.nf"
    workflow "UTILS_OPTIONS"

    tag "subworkflows"
    tag "subworkflows_nfneuro"
    tag "subworkflows/utils_options"

    test("utils_options - compare with defaults") {

        when {
            workflow {
                """
                // Create a test meta.yml file content
                def test_meta_content = '''
name: "test_workflow"
input:
  - options:
      type: map
      description: Map of options for the test workflow.
      mandatory: false
      entries:
        option_a:
          type: boolean
          description: Enable feature A
          default: false
        option_b:
          type: boolean
          description: Enable feature B
          default: true
        option_c:
          type: boolean
          description: Enable feature C
          default: false
'''
                // Write test meta file
                def test_meta_file = file("\${workDir}/test_meta.yml")
                test_meta_file.text = test_meta_content

                input[0] = "\${workDir}/test_meta.yml"
                input[1] = [
                    "option_a": true,
                    "option_b": false,
                    "option_d": true  // Not in defaults
                ]
                input[2] = false  // strict = false, allow unknown options
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.options }
            )
        }
    }

    test("utils_options - strict mode false") {

        when {
            workflow {
                """
                // Create a test meta.yml file content
                def test_meta_content = '''
name: "test_workflow"
input:
  - options:
      type: map
      description: Map of options for the test workflow.
      mandatory: false
      entries:
        option_a:
          type: boolean
          description: Enable feature A
          default: false
        option_b:
          type: boolean
          description: Enable feature B
          default: true
'''
                // Write test meta file
                def test_meta_file = file("\${workDir}/test_meta_strict_false.yml")
                test_meta_file.text = test_meta_content

                input[0] = "\${workDir}/test_meta_strict_false.yml"
                input[1] = [
                    "option_a": true,
                    "option_unknown": false  // Unknown option, but strict=false so it should be accepted
                ]
                input[2] = false  // strict = false
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.options }
            )
        }
    }

    test("utils_options - strict mode true") {

        when {
            workflow {
                """
                // Create a test meta.yml file content
                def test_meta_content = '''
name: "test_workflow"
input:
  - options:
      type: map
      description: Map of options for the test workflow.
      mandatory: false
      entries:
        option_a:
          type: boolean
          description: Enable feature A
          default: false
        option_b:
          type: boolean
          description: Enable feature B
          default: true
'''
                // Write test meta file
                def test_meta_file = file("\${workDir}/test_meta_strict_true.yml")
                test_meta_file.text = test_meta_content

                input[0] = "\${workDir}/test_meta_strict_true.yml"
                input[1] = [
                    "option_a": true,
                    "option_unknown": false  // Unknown option, strict=true so it should be ignored with warning
                ]
                input[2] = true  // strict = true
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.options }
            )
        }
    }

    test("utils_options - with partial options") {

        when {
            workflow {
                """
                // Create a test meta.yml file content
                def test_meta_content = '''
name: "test_workflow"
input:
  - options:
      type: map
      description: Map of options for the test workflow.
      mandatory: false
      entries:
        option_a:
          type: boolean
          description: Enable feature A
          default: false
        option_b:
          type: boolean
          description: Enable feature B
          default: true
'''
                // Write test meta file
                def test_meta_file = file("\${workDir}/test_meta_partial.yml")
                test_meta_file.text = test_meta_content

                input[0] = "\${workDir}/test_meta_partial.yml"
                input[1] = [
                    "option_a": true,
                    "option_unknown": false
                ]
                input[2] = true  // strict = true (default)
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.options }
            )
        }
    }

    test("utils_options - all defaults") {

        when {
            workflow {
                """
                // Create a test meta.yml file content
                def test_meta_content = '''
name: "test_workflow"
input:
  - options:
      type: map
      description: Map of options for the test workflow.
      mandatory: false
      entries:
        option_a:
          type: boolean
          description: Enable feature A
          default: false
        option_b:
          type: boolean
          description: Enable feature B
          default: true
'''
                // Write test meta file
                def test_meta_file = file("\${workDir}/test_meta_defaults.yml")
                test_meta_file.text = test_meta_content

                input[0] = "\${workDir}/test_meta_defaults.yml"
                input[1] = [:]  // Empty options, should use all defaults
                input[2] = true  // strict = true (default)
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.out.options }
            )
        }
    }

    test("utils_options - invalid options type") {

        when {
            workflow {
                """
                // Create a test meta.yml file content
                def test_meta_content = '''
name: "test_workflow"
input:
  - options:
      type: map
      description: Map of options for the test workflow.
      mandatory: false
      entries:
        option_a:
          type: boolean
          description: Enable feature A
          default: false
'''
                // Write test meta file
                def test_meta_file = file("\${workDir}/test_meta_invalid.yml")
                test_meta_file.text = test_meta_content

                input[0] = "\${workDir}/test_meta_invalid.yml"
                input[1] = ["option_a", "option_b"]  // List instead of Map - should fail
                input[2] = true  // strict = true (default)
                """
            }
        }

        then {
            assertAll(
                { assert workflow.failed },
                { assert workflow.stdout.contains("ERROR ~ Options must be a Map, but received java.util.ArrayList") }
            )
        }
    }
}
